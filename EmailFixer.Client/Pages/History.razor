@page "/history"
@inject IEmailValidationService ValidationService
@inject IUserService UserService
@inject INotificationService NotificationService

<PageTitle>Validation History - Email Fixer</PageTitle>

<div class="container mt-4">
    <div class="card shadow">
        <div class="card-header bg-info text-white">
            <h3><i class="fas fa-history"></i> Validation History</h3>
        </div>
        <div class="card-body">
            @if (IsLoading)
            {
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3">Loading history...</p>
                </div>
            }
            else if (!HistoryRecords.Any())
            {
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> No validation history found.
                    <a href="/" class="alert-link">Start validating emails</a>
                </div>
            }
            else
            {
                <div class="mb-3">
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">Filter by status:</label>
                            <select class="form-select" @bind="FilterStatus" @bind:after="ApplyFilter">
                                <option value="">All</option>
                                <option value="Valid">Valid</option>
                                <option value="Invalid">Invalid</option>
                                <option value="Suspicious">Suspicious</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">&nbsp;</label>
                            <button class="btn btn-danger w-100" @onclick="ClearHistory">
                                <i class="fas fa-trash"></i> Clear All History
                            </button>
                        </div>
                    </div>
                </div>

                <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                    <table class="table table-hover" style="display: block; width: 100%;">
                        <thead style="position: sticky; top: 0; display: block; width: 100%;">
                            <tr>
                                <th style="width: 15%;">Date</th>
                                <th style="width: 25%;">Email</th>
                                <th style="width: 12%;">Status</th>
                                <th style="width: 20%;">Message</th>
                                <th style="width: 18%;">Suggestion</th>
                                <th style="width: 10%;">MX Record</th>
                            </tr>
                        </thead>
                        <tbody style="display: block;">
                            @if (FilteredRecords.Any())
                            {
                                <Virtualize Items="@FilteredRecords" Context="record" OverscanCount="5">
                                    <tr class="@GetRowClass(record.Status.ToString())" style="display: table; width: 100%; table-layout: fixed;">
                                        <td style="width: 15%;">@record.CheckedAt.ToString("yyyy-MM-dd HH:mm")</td>
                                        <td class="font-monospace" style="width: 25%; word-break: break-all;">@record.Email</td>
                                        <td style="width: 12%;">
                                            <span class="badge @GetStatusBadgeClass(record.Status.ToString())">
                                                @record.Status
                                            </span>
                                        </td>
                                        <td style="width: 20%;">@record.Message</td>
                                        <td style="width: 18%; word-break: break-all;">
                                            @if (!string.IsNullOrEmpty(record.SuggestedEmail))
                                            {
                                                <span class="text-success">@record.SuggestedEmail</span>
                                            }
                                        </td>
                                        <td style="width: 10%; text-align: center;">
                                            @if (record.MxRecordExists)
                                            {
                                                <i class="fas fa-check text-success"></i>
                                            }
                                            else
                                            {
                                                <i class="fas fa-times text-danger"></i>
                                            }
                                        </td>
                                    </tr>
                                </Virtualize>
                            }
                            else
                            {
                                <tr><td colspan="6" class="text-center py-4">No records found</td></tr>
                            }
                        </tbody>
                    </table>
                </div>

                @if (HasMoreRecords)
                {
                    <div class="text-center mt-3">
                        <button class="btn btn-outline-primary" @onclick="LoadMore" disabled="@IsLoadingMore">
                            @if (IsLoadingMore)
                            {
                                <span class="spinner-border spinner-border-sm me-2"></span>
                            }
                            Load More
                        </button>
                    </div>
                }

                <div class="mt-3">
                    <div class="row text-center">
                        <div class="col">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="text-success">@TotalValid</h5>
                                    <small>Valid</small>
                                </div>
                            </div>
                        </div>
                        <div class="col">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="text-danger">@TotalInvalid</h5>
                                    <small>Invalid</small>
                                </div>
                            </div>
                        </div>
                        <div class="col">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="text-warning">@TotalSuspicious</h5>
                                    <small>Suspicious</small>
                                </div>
                            </div>
                        </div>
                        <div class="col">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="text-primary">@TotalRecords</h5>
                                    <small>Total Checked</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@code {
    private List<EmailCheckModel> HistoryRecords = new();
    private List<EmailCheckModel> FilteredRecords = new();
    private bool IsLoading = true;
    private bool IsLoadingMore = false;
    private bool HasMoreRecords = true;
    private int CurrentPage = 0;
    private const int PageSize = 20;
    private string FilterStatus = string.Empty;
    private UserModel? CurrentUser = null;

    // CACHE: Pre-computed status counts (updated only on data change, not every render)
    private int _cachedTotalValid = 0;
    private int _cachedTotalInvalid = 0;
    private int _cachedTotalSuspicious = 0;

    private int TotalValid => _cachedTotalValid;
    private int TotalInvalid => _cachedTotalInvalid;
    private int TotalSuspicious => _cachedTotalSuspicious;
    private int TotalRecords => HistoryRecords.Count;

    protected override async Task OnInitializedAsync()
    {
        CurrentUser = await UserService.GetCurrentUserAsync();
        if (CurrentUser != null)
        {
            await LoadHistory();
        }
        IsLoading = false;
    }

    private async Task LoadHistory()
    {
        if (CurrentUser == null)
        {
            return;
        }

        var records = await ValidationService.GetUserHistoryAsync(CurrentUser.Id, CurrentPage * PageSize, PageSize);
        HistoryRecords.AddRange(records);
        HasMoreRecords = records.Count == PageSize;
        UpdateCaches();
        ApplyFilter();
    }

    private async Task LoadMore()
    {
        IsLoadingMore = true;
        CurrentPage++;
        await LoadHistory();
        IsLoadingMore = false;
    }

    private void ApplyFilter()
    {
        if (string.IsNullOrEmpty(FilterStatus))
        {
            FilteredRecords = HistoryRecords;
        }
        else
        {
            FilteredRecords = HistoryRecords
                .Where(r => r.Status.ToString() == FilterStatus)
                .ToList();
        }
    }

    /// <summary>
    /// Update cached counts - only called when data changes, not every render
    /// This prevents O(n) scans on every render
    /// </summary>
    private void UpdateCaches()
    {
        _cachedTotalValid = HistoryRecords.Count(r => r.Status == EmailValidationStatus.Valid);
        _cachedTotalInvalid = HistoryRecords.Count(r => r.Status == EmailValidationStatus.Invalid);
        _cachedTotalSuspicious = HistoryRecords.Count(r => r.Status == EmailValidationStatus.Suspicious);
    }

    private void ClearHistory()
    {
        HistoryRecords.Clear();
        FilteredRecords.Clear();
        CurrentPage = 0;
        _cachedTotalValid = 0;
        _cachedTotalInvalid = 0;
        _cachedTotalSuspicious = 0;
    }

    private string GetRowClass(string status) => status switch
    {
        "Valid" => "table-success",
        "Invalid" => "table-danger",
        "Suspicious" => "table-warning",
        _ => ""
    };

    private string GetStatusBadgeClass(string status) => status switch
    {
        "Valid" => "bg-success",
        "Invalid" => "bg-danger",
        "Suspicious" => "bg-warning",
        _ => "bg-secondary"
    };
}
